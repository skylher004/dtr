<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>DTR Generator — One Click</title>
<style>
body{font-family:sans-serif;margin:20px;background:#f7f8fb}
input, button{margin:5px 0;padding:8px;font-size:14px}
#status{margin-top:10px;font-weight:bold;}
</style>
</head>
<body>
<h2>DTR Generator — One Click</h2>
<p>Upload your attendance CSV:</p>
<input id="attendanceCSV" type="file" accept=".csv">
<br>
<button id="generateBtn">Generate DTR</button>
<p id="status"></p>

<!-- SheetJS library -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
// CSV parser
function parseCSV(text){
    return text.split(/\r?\n/).map(line => line.split(','));
}

// Time helpers
function parseTimeToHours(timeStr){
    let t=timeStr.trim().toUpperCase();
    let m=0;
    let match=t.match(/^(\d{1,2})(?::(\d{1,2}))?\s*(AM|PM)$/);
    if(match){
        let h=parseInt(match[1]); if(match[2]) m=parseInt(match[2]);
        if(match[3]==='PM' && h!==12) h+=12;
        if(match[3]==='AM' && h===12) h=0;
        return {h,m};
    }
    let h=parseInt(t); return {h,m};
}
function formatHM(h,m){ const ampm=h>=12?'PM':'AM'; h=h%12||12; return h+':'+String(m).padStart(2,'0')+' '+ampm; }

document.getElementById('generateBtn').addEventListener('click', async ()=>{
    const file=document.getElementById('attendanceCSV').files[0];
    if(!file){ alert("Select attendance CSV"); return;}
    document.getElementById('status').textContent='Processing...';

    const csvText = await file.text();
    const csvRows = parseCSV(csvText);
    const headers = csvRows[0].map(h=>h.trim());
    const data = csvRows.slice(1);

    if(data.length===0){ alert('No attendance data'); return;}

    // Load template automatically from same folder
    const res = await fetch('DTR TEMPLATE.xlsx');
    const ab = await res.arrayBuffer();
    const wb = XLSX.read(ab, {type:'array'});

    // First sheet
    const ws = wb.Sheets[wb.SheetNames[0]];

    // Map columns (adjust based on your CSV headers)
    const dateCol = headers.find(h=>/date/i.test(h));
    const staffCol = headers.find(h=>/staff/i.test(h));
    const hubCol = headers.find(h=>/profile station/i.test(h));
    const shiftCol = headers.find(h=>/shift name/i.test(h));
    const deptCol = headers.find(h=>/profile department/i.test(h));
    const clockInCol = headers.find(h=>/clock in/i.test(h));
    const clockOutCol = headers.find(h=>/clock out/i.test(h));

    if(!dateCol || !staffCol){ alert('CSV must have Date and Staff columns'); return;}

    // Fill first staff header info
    const firstRow = data[0];
    const staffName = firstRow[headers.indexOf(staffCol)];
    const hub = firstRow[headers.indexOf(hubCol)] || 'Talavera Hub';
    const shiftStart = firstRow[headers.indexOf(shiftCol)] || '2AM';
    const profileDept = firstRow[headers.indexOf(deptCol)] || 'Backroom';

    function setCell(cell,value){ ws[cell] = {v:value,t:'s'}; }

    setCell('B9', staffName);
    setCell('C9', staffName);
    setCell('D9', staffName);
    setCell('G9', hub);

    // Period coverage
    const dates = data.map(r=>new Date(r[headers.indexOf(dateCol)]));
    const minDate = new Date(Math.min(...dates));
    const maxDate = new Date(Math.max(...dates));
    const monthNames=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
    setCell('K9', `${monthNames[minDate.getMonth()]} ${minDate.getDate()} - ${monthNames[maxDate.getMonth()]} ${maxDate.getDate()}`);

    // Department checkboxes
    setCell('P8', (profileDept==='Team Leader')?'☑':'☐');
    setCell('P9', (profileDept==='Backroom')?'☑':'☐');
    setCell('P10',(profileDept==='Coordinator')?'☑':'☐');

    // Fill daily rows B15-B30
    const rowStart=15;
    data.forEach((r,i)=>{
        const rowNum=rowStart+i;
        const dateVal = new Date(r[headers.indexOf(dateCol)]);
        setCell('B'+rowNum, dateVal.getDate());
        setCell('D'+rowNum, shiftStart);

        // Calculate 9hr shift end
        let {h,m} = parseTimeToHours(shiftStart);
        let endH = (h+9)%24;
        setCell('E'+rowNum, formatHM(endH,m));

        setCell('F'+rowNum, r[headers.indexOf(clockInCol)] || '');
        setCell('G'+rowNum, r[headers.indexOf(clockOutCol)] || '');
    });

    // Staff summary L34-R34
    const summaryRow=34;
    ['L','M','N','O','P','Q','R'].forEach((col,i)=>{
        setCell(col+summaryRow, staffName);
    });

    // Export
    const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
    const blob = new Blob([wbout], {type:'application/octet-stream'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'DTR_Filled.xlsx';
    a.click();
    document.getElementById('status').textContent='DTR generated successfully!';
});
</script>
</body>
</html>
